name: CI - Quality Gate (Tests & Build)

on:
  # Trigger on Pull Requests (The Guardrail)
  pull_request:
    branches: [ main ]
  # Also trigger on push to main, just to be sure
  push:
    branches: [ main ]

jobs:
  # ------------------------------------
  # JOB 1: TEST THE FRONTEND (React)
  # ------------------------------------
  frontend-check:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./client  # <--- Points to your React folder

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: client/package-lock.json

    - name: Install Dependencies
      run: npm ci  # 'ci' is faster/cleaner than 'install' for pipelines

    - name: Check for Syntax Errors (Build)
      run: npm run build
      env:
        CI: false # Prevents warnings from failing the build


  # ------------------------------------
  # JOB 2: TEST THE BACKEND (Azure Functions)
  # ------------------------------------
  backend-check:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./server-azure  # <--- Points to your API folder

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: server-azure/package-lock.json

    - name: Install Dependencies
      run: npm install  # 'ci' is faster/cleaner than 'install' for pipelines

    # Azure Functions don't strictly "build" like React, but we can check if packages install correctly
    - name: Verify Installation
      run: npm list --depth=0

    - name: Run Unit Tests
      run: npm test -- --passWithNoTests